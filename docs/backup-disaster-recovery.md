# Backup and Disaster Recovery

Work in Progress (WIP) notes on backup and disaster recovery.

This will need to be updated once [#156](https://github.com/spantaleev/matrix-docker-ansible-deploy/pull/516) is merged.

## Backup

1. check there is enough free space in the location you plan to backup to.
    * e.g.: `[root@matrix ~]# df -h /var/tmp/backup`
1. generate a PG dump as per  [maintenance-postgres.md](maintenance-postgres.md)
    * e.g.: `[root@matrix ~]# docker run --rm --log-driver=none --network=matrix --env-file=/matrix/postgres/env-postgres-psql postgres:13.0-alpine pg_dumpall -h matrix-postgres | gzip -c > /var/tmp/postgres.sql.gz`
    * n.b.: make sure you always have current backups. [This is because newer Postgres versions cannot start with data generated by older Postgres versions.](maintenance-postgres.md#upgrading-postgresql)
1. copy PG dump off the server, onto a destination of your choice
    * e.g.: `pcfe@t3600 tmp $ scp root@matrix.pcfe.net:/var/tmp/postgres.sql.gz .`
1. recursively copy `/matrix/synapse/storage/media-store/` off the server, onto a destination of your choice (n.b.: path uses `-`, not the `_` as I was expecting)
    * e.g.: `pcfe@t3600 tmp $ scp root@matrix.pcfe.net:/matrix/synapse/storage/media-store .`

## Disaster Recovery

1. Install a fresh CentOS 7, with the same hostname
1. install (but not start) as per [install.md](install.md)
    1. `ansible-playbook --ask-vault-pass --inventory ~/work/git/HouseNet/ansible/inventories/matrix-docker-ansible-deploy-inventory setup.yml --tags=setup-all`
1. pick a place with enough free space available on your matrix server
    * e.g.: `[root@matrix ~]# mkdir /var/tmp/restore`
1. copy your whole media store onto the matrix server
    * e.g.: `user@workstation ~ $ scp -r media-store root@matrix.pcfe.net:/var/tmp/restore/`
1. copy your PG dump backup onto the matrix server
    * e.g.: `user@workstation ~ $ scp postgres.sql.gz root@matrix.pcfe.net:/var/tmp/restore/`
1. restore media store as per [importing-media-store.md](importing-media-store.md)
    * e.g.: `ansible-playbook --ask-vault-pass --inventory ~/work/git/HouseNet/ansible/inventories/matrix-docker-ansible-deploy-inventory --extra-vars='server_path_media_store=/var/tmp/restore/media-store' setup.yml --tags=import-media-store`
1. restore postgres backup as per [importing-postgres.md](importing-postgres.md)
    * e.g.: `ansible-playbook --ask-vault-pass --inventory ~/work/git/HouseNet/ansible/inventories/matrix-docker-ansible-deploy-inventory --extra-vars='server_path_postgres_dump=/var/tmp/restore/postgres.sql.gz' setup.yml --tags=import-postgres`
1. start services
    1. `ansible-playbook --inventory ~/work/git/HouseNet/ansible/inventories/matrix-docker-ansible-deploy-inventory --ask-vault-pass setup.yml --tags=start`

## Missing

1. jitsi user was gone, what should have been restored for that?
